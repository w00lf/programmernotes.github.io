<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Programming notes]]></title><description><![CDATA[Helpfull articles about programming and software development]]></description><link>https://programmernotes.info</link><generator>GatsbyJS</generator><lastBuildDate>Mon, 06 Sep 2021 11:42:47 GMT</lastBuildDate><item><title><![CDATA[Stress testing with jmeter cluster on ec2 spot instances]]></title><description><![CDATA[Recently i needed to perform stress test testing on one of my projects. I needed to simulate user interactions at a high scale and determine…]]></description><link>https://programmernotes.info/jmeter-cluster-ec2-spot-testing/</link><guid isPermaLink="false">https://programmernotes.info/jmeter-cluster-ec2-spot-testing/</guid><pubDate>Sat, 04 Sep 2021 11:22:01 GMT</pubDate><content:encoded>&lt;p&gt;Recently i needed to perform stress test testing on one of my projects. I needed to simulate user interactions at a high scale and determine the exact breaking point of the application. Now, there are a lot of tools to do that, you even have cloud-based solutions that can do a lot of things for your $. Being an engineer i rejected such tools an was determined to create my own cloud testing stand, in additon i heard a lot about new aws instances type - &lt;a href=&quot;https://aws.amazon.com/ec2/spot/?cards.sort-by=item.additionalFields.startDateTime&amp;#x26;cards.sort-order=asc&amp;#x26;trk=ps_a134p000006vwFnAAI&amp;#x26;trkCampaign=acq_paid_search_brand&amp;#x26;sc_channel=PS&amp;#x26;sc_campaign=acquisition_RU&amp;#x26;sc_publisher=Google&amp;#x26;sc_category=Cloud%20Computing&amp;#x26;sc_country=RU&amp;#x26;sc_geo=EMEA&amp;#x26;sc_outcome=acq&amp;#x26;sc_detail=aws%20ec2%20spot%20instances&amp;#x26;sc_content=EC2%20Spot_e&amp;#x26;sc_matchtype=e&amp;#x26;sc_segment=517625976421&amp;#x26;sc_medium=ACQ-P%7CPS-GO%7CBrand%7CDesktop%7CSU%7CCloud%20Computing%7CEC2%20Spot%7CRU%7CEN%7CText&amp;#x26;s_kwcid=AL!4422!3!517625976421!e!!g!!aws%20ec2%20spot%20instances&amp;#x26;ef_id=Cj0KCQjwssyJBhDXARIsAK98ITS8mlje2FSiwzFXLeb9sFO-7OLtgi6GyIm0371n6GPjMeRmkfJ6DEAaAlRTEALw_wcB:G:s&amp;#x26;s_kwcid=AL!4422!3!517625976421!e!!g!!aws%20ec2%20spot%20instances&quot;&gt;Amazon EC2 Spot Instances&lt;/a&gt;. Spot instances are instances that consisted of leftovers of ec2 platform, eg amazon is running its huge servers to provide ec2 facilities and they don’t always used for 100%. That’s where you can save a lot of money if your setup does not require real-time availability. The catch here is that these leftovers can be claimed by aws at any time and your cheap t3.2xlarge instance will just go poof and be removed. Now, that can be addressed by enabling persistent support for additional $ and other settings but that’s a topic for another blog post.&lt;/p&gt;
&lt;h2&gt;Stress test conditions&lt;/h2&gt;
&lt;p&gt;I needed to perform a stress test with a sequence of requests written before by jmeter proxy requests. I needed at least 1000 active users in a span of a minute. In addition to api interaction, these scripts also required downloading large(5+Mb) static assets. After some manual testing, i determined i need at least &lt;code class=&quot;language-text&quot;&gt;t3.2xlarge&lt;/code&gt; server, preferably 2 of them. Jmeter is not the most efficient tool in terms of resource consumption, there are other ones like, for example &lt;a href=&quot;http://tsung.erlang-projects.org/&quot;&gt;tsung&lt;/a&gt; that can do it much more efficiently, but jmeter was the easiest one to use and spot instances allows you to not think a lot about consumed resources.&lt;/p&gt;
&lt;h2&gt;Cluster server creation&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;First step go to ec2 page and press &lt;code class=&quot;language-text&quot;&gt;Launch instances&lt;/code&gt;, then select preferably os type, i choose Ubuntu 20 for its simplicity of configuration.&lt;/li&gt;
&lt;li&gt;Choose your instance size, as described above, i needed at least 20Gb of memory so i decided to go with &lt;code class=&quot;language-text&quot;&gt;t3.2xlarge&lt;/code&gt;(8 cpu and 32 Gb of memory)
&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3486b70c2c97059f2cd44b2d10e2712c/2c960/instance_size.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 38.60759493670886%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABPElEQVQoz3VR2XKDMAzk/3+y02sIkITYxrfNdiVo2j6UQWOtDntXGsZpxvjxivHzDeO04PpwcD7BbAF2i/Qj7tbD+sNPOSPnQsuHlfIHDylGhLChlAxjHogxQL9959/RW1MYgkc7/Vorczt677DGKBaT2kGCpVQt9N6zMWijWBVjofjruioDuei7ppDdPM8kQeYpK+aFbD5fFHYpJX1Z4mrtOCMvOZh1bdS+VrE5p+pqLYqHXBpCIujAwzgYS/m1Q+KJzCNzgm/3FSGyse3YOMtc+QhnN14mxZ65RDy4SDkuIRTgcjWYbxYudkjchqq5LXV8Tnf1fd5xM0Hzxhe8vF8Ua108JVdKkCWkFFFkTr8l9x/J7ZQs9ft/kmXwkXPbuRRjyI4FMsPnYnQpnTnzXIos4VhKxbIsiiUn+Atg2XBZOZzpKAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;ec2 instance size&quot;
        title=&quot;ec2 instance size&quot;
        src=&quot;/static/3486b70c2c97059f2cd44b2d10e2712c/f058b/instance_size.png&quot;
        srcset=&quot;/static/3486b70c2c97059f2cd44b2d10e2712c/c26ae/instance_size.png 158w,
/static/3486b70c2c97059f2cd44b2d10e2712c/6bdcf/instance_size.png 315w,
/static/3486b70c2c97059f2cd44b2d10e2712c/f058b/instance_size.png 630w,
/static/3486b70c2c97059f2cd44b2d10e2712c/40601/instance_size.png 945w,
/static/3486b70c2c97059f2cd44b2d10e2712c/78612/instance_size.png 1260w,
/static/3486b70c2c97059f2cd44b2d10e2712c/2c960/instance_size.png 2870w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Next, you need to actually tell amazon that you want to use spot instance: &lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2f1d35854cc66c3e6f004f2598b780f6/9f75f/instance_details.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 43.67088607594937%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABOklEQVQoz5WSC26DMAyGuf8BttvsBtsB1rWIUSgBmkDzgDzIP4c+VGmq1ln6cOyIP46drGpasJ6jYj1Yd0R9KCF4h5OeVpSZIMkLaVafYmvtQzKjNYzROPY9TuMAle/gyScLYYENEbOP8LR+xrL0iTEiXhKaHfFdc5RiQtFJ5OyEHZF82UuwwaAR+oKi+LxO+U55ZEkshIBhGGC0Ap8CCiZQVS16LjFod2M0Dmr2D9F2OQsmlFJ0dbMKF5sNqo93yO0X/mur4L0Z7yHaFrwsYamvoDhe2/IEtx5KKWGdg8xz8O0WIzHv94jL72HcHxCWMzfBaw97qkakPtY1OAlpmr6nZ+Bpz1OV1oV10tcf/7zyQpWkd+Qp1tO09jNQLh02zzPlHGa3rPWRNkapkZcNXt9qvBCfRQN2qPED7E6648KSUzQAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;ec2 instance details&quot;
        title=&quot;ec2 instance details&quot;
        src=&quot;/static/2f1d35854cc66c3e6f004f2598b780f6/f058b/instance_details.png&quot;
        srcset=&quot;/static/2f1d35854cc66c3e6f004f2598b780f6/c26ae/instance_details.png 158w,
/static/2f1d35854cc66c3e6f004f2598b780f6/6bdcf/instance_details.png 315w,
/static/2f1d35854cc66c3e6f004f2598b780f6/f058b/instance_details.png 630w,
/static/2f1d35854cc66c3e6f004f2598b780f6/40601/instance_details.png 945w,
/static/2f1d35854cc66c3e6f004f2598b780f6/78612/instance_details.png 1260w,
/static/2f1d35854cc66c3e6f004f2598b780f6/9f75f/instance_details.png 2858w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;. We will be using 3 instances - one will work as jmeter master and results collector and the other will perform the actual testing. &lt;code class=&quot;language-text&quot;&gt;t3.2xlarge&lt;/code&gt; instance size for jmeter master is a little overkill, but again, i did not want to spend a lot of time on configuration. Check &lt;code class=&quot;language-text&quot;&gt;Request spot instances&lt;/code&gt; checkbox. After you check this option you will see the actual current prices for specified regions. Spot instances have floating pricing and can change depending on the time of the day and aws loading. In order to not blow up your budgets, you need to specify the maximum hourly price you are willing to pay for each instance. If your instance overcomes such price it will be terminated. For simplicity just set it 2 times the pricing of the current price, that will be more than safe.&lt;/li&gt;
&lt;li&gt;Add some storage for the server. Jmeter uses static heap files for its testing, 1000 concurrent users with assets download will require at least 10Gb of disk storage, so we add 40 Gb disk.
&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/dd29570646851f5d45f9cebaeb47df60/8b95f/instance_storage.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 44.93670886075949%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABRUlEQVQoz32SaW6DMBCFuf8pKvUq7QX6N6pKMV6wsZ3YTghLeB0bpYuaBOljzJuZ5zFQ1Uyg4Qrvny1076EIbT2M4tCmh3H7oinjy9r5A0IIRESIibjGjYqxBpy3hUjJGHPxAZFIaXs+poSUc2QUjwNxwr2ratsWXdcVtNaQUkIpBescOGPoaC2K1sF7mpKmVlTLKJfr6vqj9AghS74SnMNZi77vCUMNBlwIGCoyb2/wux2k4GBNQ40C1pIh5fKJTO8gux6Wejn5FENtLNw+YFouxFrieVowTjPOzmMKCSPpWctM81Z398jCJdSKdtqfoPYDpD9t0LM8DAUVZooj5XPuCB0nnOdsumJd/1INtOswLtsUVJTjN/OmXfXfcbn8NyuGP8OuD8Ad7caRb+3yCLqBXiMC/T5MaDy/Kjy9KOyajj6OxhfEULSuofhKhAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Disk size&quot;
        title=&quot;Disk size&quot;
        src=&quot;/static/dd29570646851f5d45f9cebaeb47df60/f058b/instance_storage.png&quot;
        srcset=&quot;/static/dd29570646851f5d45f9cebaeb47df60/c26ae/instance_storage.png 158w,
/static/dd29570646851f5d45f9cebaeb47df60/6bdcf/instance_storage.png 315w,
/static/dd29570646851f5d45f9cebaeb47df60/f058b/instance_storage.png 630w,
/static/dd29570646851f5d45f9cebaeb47df60/40601/instance_storage.png 945w,
/static/dd29570646851f5d45f9cebaeb47df60/78612/instance_storage.png 1260w,
/static/dd29570646851f5d45f9cebaeb47df60/8b95f/instance_storage.png 2848w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Skip tags step, go to 6th step: security settings. This is an important step for our setup. Because we are going to use Jmeter in cluster mode we need to open specific ports in order for the master and its cluster servers to communicate with each other and to servers to pass their test results back to the master. &lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/78346c0e4db9ae020a732b41821a3a72/3c1e5/instance_security.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 31.0126582278481%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABGUlEQVQY01VQ2W6DQAzk/3+rjULShBw9XqNGnA0BwrIHLDC1jSo1iJF3x2N71sF6G2FFeAk5HvC62WOzP2EbnSme8RadsAnXCNcrbHcRdscPnN6/cDwzPp9wIARlWeKnKJAkCdI0QZblUKqFtYZgYQ1Fo2G0gtbdwhNnmHM9rBuWPIH5APRN04y2bdEqheahqHGKPM9JZOC9x0DwgpG00z/MoP+JC/6c1HWNOI7F7fX6TU4zQUH32+2Gx6ORoX3fwzlHsFKntSbOCce5gAvu9zsMJauqImeFiLquI6cZeCXGWGnKA9l5VdVomkb0l8tF1sU67kUNcypWWJ4+Yhw9ME9y58mjH+TsKfKeeI98nqdR9I5eKNzQS/4XriPFDH1BROYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;ec2 Instance security&quot;
        title=&quot;ec2 Instance security&quot;
        src=&quot;/static/78346c0e4db9ae020a732b41821a3a72/f058b/instance_security.png&quot;
        srcset=&quot;/static/78346c0e4db9ae020a732b41821a3a72/c26ae/instance_security.png 158w,
/static/78346c0e4db9ae020a732b41821a3a72/6bdcf/instance_security.png 315w,
/static/78346c0e4db9ae020a732b41821a3a72/f058b/instance_security.png 630w,
/static/78346c0e4db9ae020a732b41821a3a72/40601/instance_security.png 945w,
/static/78346c0e4db9ae020a732b41821a3a72/78612/instance_security.png 1260w,
/static/78346c0e4db9ae020a732b41821a3a72/3c1e5/instance_security.png 2854w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;. Now i must warn you that the setting i use there is quite dangerous and you should never set up your production server as described above, but because i was going to use these servers for no more than 30m minutes and then just terminate them i decided to not bother with security group configuration and just allowed all incoming traffic to the servers, you should definitely use aws security groups for your production servers.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Server confuration&lt;/h2&gt;
&lt;p&gt;After that, i got 3 servers preparing to launch i wrote a simple ansible role to actually configure these servers and load all necessary files.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;---&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Install openjdk
  &lt;span class=&quot;token key atrule&quot;&gt;apt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; openjdk&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;16&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;jre
    &lt;span class=&quot;token key atrule&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; present
    &lt;span class=&quot;token key atrule&quot;&gt;update_cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; yes
  &lt;span class=&quot;token key atrule&quot;&gt;become&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; yes

&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Install unzip
  &lt;span class=&quot;token key atrule&quot;&gt;apt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;  unzip
    &lt;span class=&quot;token key atrule&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; present
  &lt;span class=&quot;token key atrule&quot;&gt;become&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; yes

&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Download and Unarchive jmeter
  &lt;span class=&quot;token key atrule&quot;&gt;ansible.builtin.unarchive&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; https&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//dlcdn.apache.org//jmeter/binaries/apache&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;jmeter&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;5.4.1.zip
    &lt;span class=&quot;token key atrule&quot;&gt;dest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /home/ubuntu/
    &lt;span class=&quot;token key atrule&quot;&gt;remote_src&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; yes

&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Copy jmeter configs and binaries
  &lt;span class=&quot;token key atrule&quot;&gt;copy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; src=&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; item &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; dest=/home/ubuntu/apache&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;jmeter&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;5.4.1/bin/&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; item &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; owner=ubuntu group=ubuntu
  &lt;span class=&quot;token key atrule&quot;&gt;with_items&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; jmeter
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; jmeter.properties

&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Create stress_test dir
  &lt;span class=&quot;token key atrule&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; directory
    &lt;span class=&quot;token key atrule&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /home/ubuntu/stress_test

&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Copy jmeter script xml
  &lt;span class=&quot;token key atrule&quot;&gt;copy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; src=requests.jmx dest=/home/ubuntu/stress_test/requests.jmx owner=ubuntu group=ubuntu

&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Copy seed csv
  &lt;span class=&quot;token key atrule&quot;&gt;copy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; src=logins.csv dest=/home/ubuntu/stress_test/logins.csv owner=ubuntu group=ubuntu&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Let’s look into each step and see what there are doing. &lt;code class=&quot;language-text&quot;&gt;Install OpenJDK uses apt to install Java 16 environment to the server. We are going to download jmeter from the official site, unzip it and overwrite some config files.&lt;/code&gt;Install unzip&lt;code class=&quot;language-text&quot;&gt;is required for handling zip files.&lt;/code&gt;Download and Unarchive jmeter&lt;code class=&quot;language-text&quot;&gt;is used to download jmeter script and unzip it into the desired location.&lt;/code&gt;Copy jmeter configs and binaries&lt;code class=&quot;language-text&quot;&gt;is used to tweak our JMeter settings and optimize them. Custom&lt;/code&gt;JMeter&lt;code class=&quot;language-text&quot;&gt;file is used because of memory settings, by default JMeter uses a very small heap size equal to just 1Gb, if you do not change this item you will get&lt;/code&gt;Out of heap` error if you try to simulate a large number of requests, so we are changing this line:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;diff&quot;&gt;&lt;pre class=&quot;language-diff&quot;&gt;&lt;code class=&quot;language-diff&quot;&gt;&lt;span class=&quot;token deleted-sign deleted&quot;&gt;&lt;span class=&quot;token prefix deleted&quot;&gt;-&lt;/span&gt;: &quot;${HEAP:=&quot;-Xms1g -Xmx1g -XX:MaxMetaspaceSize=256m&quot;}&quot;
&lt;/span&gt;&lt;span class=&quot;token inserted-sign inserted&quot;&gt;&lt;span class=&quot;token prefix inserted&quot;&gt;+&lt;/span&gt;: &quot;${HEAP:=&quot;-Xms24g -Xmx24g -XX:MaxMetaspaceSize=256m&quot;}&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;jmeter.properties&lt;/code&gt; tells jmeter to disable ssl support completely(again we are using this one for simplicity):&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;diff&quot;&gt;&lt;pre class=&quot;language-diff&quot;&gt;&lt;code class=&quot;language-diff&quot;&gt;&lt;span class=&quot;token deleted-sign deleted&quot;&gt;&lt;span class=&quot;token prefix deleted&quot;&gt;-&lt;/span&gt;#server.rmi.ssl.disable=false
&lt;/span&gt;&lt;span class=&quot;token inserted-sign inserted&quot;&gt;&lt;span class=&quot;token prefix inserted&quot;&gt;+&lt;/span&gt;server.rmi.ssl.disable=true&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next, we are creating a results directory and actually copying the test &lt;code class=&quot;language-text&quot;&gt;jmx&lt;/code&gt; xml file and our users seed list(&lt;code class=&quot;language-text&quot;&gt;Copy seed csv&lt;/code&gt;) which is just a list of user credentials to use in order for login.&lt;/p&gt;
&lt;p&gt;Next let’s actually deploy our settings and assets to our servers:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sh&quot;&gt;&lt;pre class=&quot;language-sh&quot;&gt;&lt;code class=&quot;language-sh&quot;&gt;$: ansible-playbook -i hosts jmeter_node.yml&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Cluster testing&lt;/h2&gt;
&lt;p&gt;Our servers are all set up and ready for action. Here is lying the final catch. If you try to launch &lt;code class=&quot;language-text&quot;&gt;jmeter-server&lt;/code&gt; on ec2 node you will receive a warning in the log file that it started to use internal ec2 node ip that is configured as the hostname for our servers and as such there will be problems with external requests and configuring servers to run the test. You actually need to use here your public ips:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sh&quot;&gt;&lt;pre class=&quot;language-sh&quot;&gt;&lt;code class=&quot;language-sh&quot;&gt;$: ./jmeter-server -Djava.rmi.server.hostname=%{YOUR_PUBLIC_IP}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Again, if you have configured security groups for your servers you dont need such settings at all.&lt;/p&gt;
&lt;p&gt;And the final step: launch testing on the cluster and write results into &lt;code class=&quot;language-text&quot;&gt;/home/ubuntu/stress_test/results&lt;/code&gt; folder and track the progress in &lt;code class=&quot;language-text&quot;&gt;/home/ubuntu/stress_test/results/main.csv&lt;/code&gt; file:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sh&quot;&gt;&lt;pre class=&quot;language-sh&quot;&gt;&lt;code class=&quot;language-sh&quot;&gt;mkdir -p /home/ubuntu/stress_test/results &amp;amp;&amp;amp; \
	 	 ./jmeter -Djava.rmi.server.hostname=%{YOUR_PUBLIC_IP} \
		-R ec2-1-*.compute-1.amazonaws.com,ec2-2-*.compute-1.amazonaws.com -n \
		-t /home/ubuntu/stress_test/requests.jmx -l /home/ubuntu/stress_test/results/main.csv \
		-e -o /home/ubuntu/stress_test/results&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After the test is started you can track you progress through &lt;code class=&quot;language-text&quot;&gt;main.csv&lt;/code&gt; results file. In essence, it’s just a csv file that gets its line appended by cluster servers periodically.&lt;/p&gt;
&lt;p&gt;Pandas is a perfect instrument to interpret your test results:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; pandas
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; matplotlib&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pyplot &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; plt

stress &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pandas&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;read_csv&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;main.csv&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
stress&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;timestamp&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pandas&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;to_datetime&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stress&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;timeStamp&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;unit&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;ms&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
time_series &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; stress&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;loc&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;stress&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;label&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;isin&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Login request&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;timestamp&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;responseCode&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
time_series\
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;groupby&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pandas&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Grouper&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; freq&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;15s&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;responseCode&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;\
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;count&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;\
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reset_index&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;\
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pivot&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;index&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;timestamp&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; columns&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;responseCode&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;\
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plot&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kind&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;bar&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; figsize&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stacked&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here i took the result csv downloaded from the server, converted its unix timestamp column into datetime then created data frame with timestamp/response code count grouped by each 15 seconds and then displayed a plot using &lt;code class=&quot;language-text&quot;&gt;matplotlib.pyplot&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/868a208583d8b890c2d7f0ee7fbbaee0/9d6a9/pandas_plot.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.53164556962025%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABzElEQVQoz22S208TQRTG+Y9NxAsG8F0SX3jzwTuoXVnwSfSFINpCCEYopm3CTS5pl9rZ2fvuzJZ+npnZbUvjJpPffOc7883ZzU7JNEev14PjdHDtOJpqdbvX8BlHyhh810XgciRhgIR6Y9Kcu3DJY6Q5aUZ7z/UwhVwiiSP8ZdTk+eB+AEaH41RA9vtIZA6R95ESM1qp7CMjrfZSkzwhEQYBpMgoUD832Gg6WN45x9OvLdg/r7Cw3oS9d4EnnxtYKWjvXQ71wnpD+6qvsnuOxS+/cdnlJlBKgdfVUzzbPMbsah2vqmeYsQ+oZvimRlwptGJt5D+y65p3K/vYbDkmsO2GZBzg7fYfzK8das4Rl26xPsHDW/0P6aJvZWCHAmf1JKZRTaQOqkY18f+o/aJf8cHHscA2CzC3aiZ8/MlMNL824vKEHmfZrz7F1vgrT1v7eP7jVN/0gnhf8wz3iC8VrUJbRpd+yTvvf2Gj0TGBPEzwoXaErWYb1vaxZoX4fYLDemukrZ0TzXfVIzSumAkcDG4Q+hwiSxD5HkSaGE2MAg8ZMQ5MvfTLejSsc/qlBQUOgDzPEUUx0ixDFMfICo5rRj9+HCd6pRN+SSEE/gF64P2I3ZTrJwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Pandas plot&quot;
        title=&quot;Pandas plot&quot;
        src=&quot;/static/868a208583d8b890c2d7f0ee7fbbaee0/f058b/pandas_plot.png&quot;
        srcset=&quot;/static/868a208583d8b890c2d7f0ee7fbbaee0/c26ae/pandas_plot.png 158w,
/static/868a208583d8b890c2d7f0ee7fbbaee0/6bdcf/pandas_plot.png 315w,
/static/868a208583d8b890c2d7f0ee7fbbaee0/f058b/pandas_plot.png 630w,
/static/868a208583d8b890c2d7f0ee7fbbaee0/40601/pandas_plot.png 945w,
/static/868a208583d8b890c2d7f0ee7fbbaee0/78612/pandas_plot.png 1260w,
/static/868a208583d8b890c2d7f0ee7fbbaee0/9d6a9/pandas_plot.png 2256w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Easy as it can be&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Aws spot instances is a great tool if you don’t need constant availability. It’s perfect for stress testing, CI builds and even beats lambda if you need to process a large number of tasks asynchronously.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Taming Europe routes, part 3]]></title><description><![CDATA[TL:DR previous parts I was approached by one of my clients with a work that required to parse almost 500 million European routes to see what…]]></description><link>https://programmernotes.info/taming-europe-routes-3/</link><guid isPermaLink="false">https://programmernotes.info/taming-europe-routes-3/</guid><pubDate>Sun, 14 Feb 2021 14:30:00 GMT</pubDate><content:encoded>&lt;h2&gt;TL:DR previous parts&lt;/h2&gt;
&lt;p&gt;I was approached by one of my clients with a work that required to parse almost 500 million European routes to see what routes can be traveled by land transport. After some research, i decided to use graphhopper server application and python celery library, the server was found, scripts were written and i was ready to start the parsing.&lt;/p&gt;
&lt;h2&gt;Celery configuration and tweaks&lt;/h2&gt;
&lt;p&gt;I decided to use celery because of its flexibility and simpleness of configuration. The task was to query graphhopper server, wait for the response, then write the response from workers into the file. http request is a blocking operation that python can greatly optimize. Python does not have full concurrency support because of the &lt;a href=&quot;https://wiki.python.org/moin/GlobalInterpreterLock&quot;&gt;gil&lt;/a&gt; but blocking operations such as this can run simultaneously: when we have http socket waiting for the response python can skip the waiting in the current thread and move the next thread, this way we can have almost the full concurrency. This mechanic will eventually slow down on a large scale because of the CPU load and also slower as the process concurrency model. This is the part where celery flexibility comes in place. We can start celery in multiprocess mode by supplying &lt;code class=&quot;language-text&quot;&gt;-c&lt;/code&gt;(concurrency) flag and supply the number of processes to spawn, that way we will utilize the whole number of server cores. By default, celery will start workers with the process number equal to the number of server` cores. Because i wanted to also utilize the thread concurrency model i started workers a little bit different:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$: &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token for-or-select variable&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; celery multi start &lt;span class=&quot;token variable&quot;&gt;$i&lt;/span&gt; -A proj -l INFO -c &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; -P threads&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This command creates 16 celery workers(that’s the number of cores on my server) each with a &lt;code class=&quot;language-text&quot;&gt;thread&lt;/code&gt; concurrency model and 3 worker threads each. Flag &lt;code class=&quot;language-text&quot;&gt;-P&lt;/code&gt; tells celery what concurrency model to use, available options are: prefork (default), eventlet, gevent, solo or threads. I have not tested &lt;code class=&quot;language-text&quot;&gt;eventlet&lt;/code&gt; or &lt;code class=&quot;language-text&quot;&gt;gevent&lt;/code&gt; options because the process -&gt; threads model was known to me before, many web servers use this implementation and it’s great for blocking operations.&lt;/p&gt;
&lt;p&gt;Celery can store the task call inside the broker and retrieve it by call, its not so effective in async processing but perfect for batch data processing with &lt;code class=&quot;language-text&quot;&gt;celery.group&lt;/code&gt; method. This method can accept task name and list of args to call with. Here is the example of processing a list of coordinates with &lt;code class=&quot;language-text&quot;&gt;celery.group&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;flush_batch_main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  execution_result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; celery&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;group&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lookup_directions&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      row&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; row&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; row &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; execution_result&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And in the main script i added the following code:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;CONCURENCY &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; row_1 &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; terms&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;START_POINT&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; row_2 &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; terms&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    row_batch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;append&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;start_point&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; end_point&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;row_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; CONCURENCY&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      row_batch&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; execution_result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; flush_batch&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;row_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      result_batch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;extend&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;execution_result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; max_result_batch&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Flushed&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      writer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;writerows&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; entry &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; result_batch&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        hasher&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;memorize_route&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;merged_term&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      result_batch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This code store coordinates inside &lt;code class=&quot;language-text&quot;&gt;row_batch&lt;/code&gt; accumulator until the size of this accumulator surpasses &lt;code class=&quot;language-text&quot;&gt;CONCURENCY&lt;/code&gt; number, after that, it submits the &lt;code class=&quot;language-text&quot;&gt;row_batch&lt;/code&gt; list into the worker pool after all workers complete the tasks it returns the result combined in one list.&lt;/p&gt;
&lt;p&gt;After we process the coordinates batch we need to store this result. This is a blocking operation and if we need to call it often that can lead to a performance decrease. That’s why i decided to first store the results in variable and after that exceeds some number(i decided to go with 10_000) write it into the result file:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; max_result_batch&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Flushed&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  writer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;writerows&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; entry &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; result_batch&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    hasher&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;memorize_route&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;merged_term&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  result_batch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Hungry redis&lt;/h2&gt;
&lt;p&gt;The code was written and optimized, at test runs the server cpu utilization was almost at 100%. I have started the script and left the server running. The pace was great, almost 50 million entries in one day, which gave me 10 days of parsing to complete the task. Then one day i have entered the server and noticed a big spike in memory: an additional 10 Gb was used. The server itself had 64Gb of total memory, graphhopper occupied 35, and scripts took an additional 3. The problem was that memory consumption kept growing. I inspected htop and noticed that it was redis memory consumption. Redis server used 10Gb of memory! So what was the cause of such consumption? I used redis to also store a list of routes that already checked, it was a simple key with string name and value equal to boolean. That way i could memorize what routes were processed and skip it between script restart. As it turns out, a simple key-value store is not optimized in redis and will consume a lot of memory. During my search for the solution i encountered this post: &lt;a href=&quot;https://instagram-engineering.com/storing-hundreds-of-millions-of-simple-key-value-pairs-in-redis-1091ae80f74c&quot;&gt;storing hundreds of millions of simple key-value pairs in redis&lt;/a&gt; which introduced a neat technique that can shred redis memory consumption by a lot. The technique used redis method &lt;a href=&quot;https://redis.io/commands/hset&quot;&gt;hset&lt;/a&gt; instead of the simple &lt;code class=&quot;language-text&quot;&gt;set&lt;/code&gt; key. The way it works is like this: we choose a bucket that will store the value then we store key-value parts in it. Its a simple hashing algorithm, python itself uses it for storing hashed values to avoid collisions. Such store is much more optimized by memory and without speed reduction in access. Even more, i noticed that the keys i used for completed routes were just simple strings so i decided to also hash this string to a hex string that can be easily matched during processing.&lt;/p&gt;
&lt;p&gt;Here is the code i wrote to determine the bucket we will be storing route. I decided to use 500_000 buckets by the number of routes used / 1000, so in each bucket, there will be max 1000 routes stored. python’s &lt;code class=&quot;language-text&quot;&gt;int&lt;/code&gt; method can return int representation of the hex string(that’s the second argument of &lt;code class=&quot;language-text&quot;&gt;int&lt;/code&gt;) which can be used with the remainder of dividing by &lt;code class=&quot;language-text&quot;&gt;NUMBER_BUCKETS&lt;/code&gt; to return a number from 0 to 500_000 depending on hash passed.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;NUMBER_BUCKETS &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; 500_000

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bucket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hashed_route&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hashed_route&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; NUMBER_BUCKETS&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Hash from string can be generated this way in python:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hash_route&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;route&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; hashlib&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;md5&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;route&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;encode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;utf-8&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hexdigest&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And the code for setting and retrieving keys from redis woth &lt;code class=&quot;language-text&quot;&gt;hset&lt;/code&gt; will look like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;route_exists&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;route&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  hashed_route &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hash_route&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;route&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; router&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;redis_client&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;main&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hexists&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bucket&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hashed_route&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; hashed_route&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;memorize_route&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;route&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  hashed_route &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hash_route&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;route&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; router&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;redis_client&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;main&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hset&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bucket&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hashed_route&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; hashed_route&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;1&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After these optimizations the memory consumption droped by a lot, but still redis consumed much less memory but after next iteration of parsing it still started to increase. I decided to look inside redis for the used keys. One thing i noticed was that there a lot of &lt;code class=&quot;language-text&quot;&gt;celery*&lt;/code&gt; keys inside redis:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$: redis-cli KEYS &lt;span class=&quot;token string&quot;&gt;&quot;celery*&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;wc&lt;/span&gt; -l
&lt;span class=&quot;token number&quot;&gt;500000&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;That’s strange. After some research, i found the reason behind these keys creation. As it turns out, celery can store results into the broker but by default these keys last for one day! I did not need such long time as i was collecting the values right away, the simple tweak of the celery config:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;diff&quot;&gt;&lt;pre class=&quot;language-diff&quot;&gt;&lt;code class=&quot;language-diff&quot;&gt;from __future__ import absolute_import, unicode_literals
from celery import Celery

app = Celery(&apos;router&apos;,
&lt;span class=&quot;token unchanged&quot;&gt;&lt;span class=&quot;token prefix unchanged&quot;&gt; &lt;/span&gt;            broker=&apos;redis://&apos;,
&lt;span class=&quot;token prefix unchanged&quot;&gt; &lt;/span&gt;            backend=&apos;redis://&apos;,
&lt;span class=&quot;token prefix unchanged&quot;&gt; &lt;/span&gt;            include=[&apos;router.tasks&apos;])
&lt;/span&gt;&lt;span class=&quot;token inserted-sign inserted&quot;&gt;&lt;span class=&quot;token prefix inserted&quot;&gt;+&lt;/span&gt;app.conf.result_expires = 60&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Fixed the issue and redis memory consumption dropped by a lot! After all 500 million routes parsing the redis server occupied no more than 6 Gb of memory, nice!&lt;/p&gt;
&lt;h2&gt;Retrieving the results&lt;/h2&gt;
&lt;p&gt;Parsing was progressing fast, i had the first results and they were huge. By default i stored the results into a csv file and after parsing just 50 million routes it size exceeded 12 Gb. It was obvious that i won’t have enough space to even store such results and i also needed to parse them through AdWords key planner tool. I need a more optimized by size format to work with and, as it turned out, python has support for a number of marvelous data formats. The easiest one to work from python was &lt;a href=&quot;https://parquet.apache.org/documentation/latest/&quot;&gt;parquet&lt;/a&gt;. Parquet is a binary columnar file format that can store a large array of data and can be easily converted in other formats with the help of pandas. Here is a script that can migrate csv file into the parquet one:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; pandas
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; cleaner&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;utils
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; sys
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; os

FILE_NAME &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; sys&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
CHUNK_SIZE &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8000000&lt;/span&gt;
FILE_RESULT_TEMPLATE &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;{}_{}.parquet&apos;&lt;/span&gt;
FILE_POSSIBLE_RESULT_TEMPLATE &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;{}_{}_possible.parquet&apos;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; __name__ &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;__main__&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  base_name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; os&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;basename&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FILE_NAME&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;split&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;.&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; chunk &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; pandas&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;read_csv&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FILE_NAME&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; chunksize&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;CHUNK_SIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FILE_RESULT_TEMPLATE&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base_name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    cleaned_chunk &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cleaner&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;utils&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;clean_routes_dataframe&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;chunk&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    possible &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cleaned_chunk&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;loc&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cleaned_chunk&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;distance&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cleaned_chunk&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;distance&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;750000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cleaned_chunk&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;time&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cleaned_chunk&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;time&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;28800000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    cleaned_chunk&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;to_parquet&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        FILE_RESULT_TEMPLATE&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base_name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; engine&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;pyarrow&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    possible&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;to_parquet&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        FILE_POSSIBLE_RESULT_TEMPLATE&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base_name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; engine&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;pyarrow&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    i &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I had one large csv file that was storing the parsing results and i need smaller files with no more than 8 million entries that i can easily download, read and convert to the csv and paste into AdWords keywords planner tool. This script will take the csv file name from the command line args(&lt;code class=&quot;language-text&quot;&gt;sys.argv[1]&lt;/code&gt;), open it, read in batches(remember that the original csv file is huge, we need to carefully read it in batches), and then write down a series of parquet files with indexes, no more than 8 million entries. The size optimization was a tremendous one, a 8 million rows parquet file weighted no more than 600 Mb!&lt;/p&gt;
&lt;h2&gt;Conclusions&lt;/h2&gt;
&lt;p&gt;The described architecture model is not perfect, it has a lot of bottlenecks like local requests and waiting for the results to be retrieved from celery. If i will be asked to repeat the job and have more time for the preparations i will use more optimized cli tools like &lt;a href=&quot;https://github.com/Project-OSRM/osrm-backend&quot;&gt;osrm-backend&lt;/a&gt; or &lt;a href=&quot;https://github.com/valhalla/valhalla&quot;&gt;valhalla&lt;/a&gt; but in the end, the job was successfully completed and in a short period of time - just 18 days. Hope you liked these articles and stay tuned for the next ones!&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Taming Europe routes, part 2]]></title><description><![CDATA[TL:DR previous part I was approached by one of my clients with a work that required to parse almost 500 million European routes to see what…]]></description><link>https://programmernotes.info/taming-europe-routes-2/</link><guid isPermaLink="false">https://programmernotes.info/taming-europe-routes-2/</guid><pubDate>Tue, 12 Jan 2021 19:30:00 GMT</pubDate><content:encoded>&lt;h2&gt;TL:DR previous part&lt;/h2&gt;
&lt;p&gt;I was approached by one of my clients with a work that required to parse almost 500 million European routes to see what routes can be traveled by land transport. After some research, i decided to use graphhopper server application and python celery library.&lt;/p&gt;
&lt;h2&gt;Data preparation&lt;/h2&gt;
&lt;p&gt;Graphhopper uses osm.pbf files as input files in order to correctly draw its maps and compute directions. These files can be downloaded from &lt;a href=&quot;https://download.geofabrik.de/europe.html&quot;&gt;geofabrik&lt;/a&gt; site and can be freely used. However, another issue occurred during the preparation step: file sizes. The latest Europe map weighs more than 22Gb and that’s the compressed file! Graphhopper will also extract and set up his own metadata which will require additional storage usage. Even more, the larger the osm file the more there requirements for the RAM. That’s a huge requirement for memory, so i decided to shrink this osm file as much as possible. I needed only the West Europe map without Eastern Europe, Scandinavia, and England.&lt;/p&gt;
&lt;h2&gt;Shrink OSM files&lt;/h2&gt;
&lt;p&gt;Fortunately, osm files can be easily manipulated and feated to your needs. There is a tool called [osmosis] (&lt;a href=&quot;https://wiki.openstreetmap.org/wiki/Osmosis&quot;&gt;https://wiki.openstreetmap.org/wiki/Osmosis&lt;/a&gt;) that can do that and much more. Here is an example of extracting a map of Germany with supplied polygon into a separate map file:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sh&quot;&gt;&lt;pre class=&quot;language-sh&quot;&gt;&lt;code class=&quot;language-sh&quot;&gt;$: osmosis --read-xml file=&amp;quot;planet-latest.osm&amp;quot; --bounding-polygon file=&amp;quot;country2pts.txt&amp;quot; --write-xml file=&amp;quot;germany.osm&amp;quot;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Where &lt;code class=&quot;language-text&quot;&gt;country2pts.txt&lt;/code&gt; is a &lt;a href=&quot;https://wiki.openstreetmap.org/wiki/Osmosis/Polygon_Filter_File_Format&quot;&gt;polygon filter file&lt;/a&gt;. In order to create such polygon one can use an online tool called &lt;a href=&quot;https://export.hotosm.org/en/v3/exports/new/describe&quot;&gt;hotosm&lt;/a&gt;. The polygon file itself is just a collection of map points on each row that describes our polygon boundaries:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;txt&quot;&gt;&lt;pre class=&quot;language-txt&quot;&gt;&lt;code class=&quot;language-txt&quot;&gt;australia_v
first_area
     0.1446693E+03    -0.3826255E+02
     0.1446627E+03    -0.3825661E+02
     0.1446763E+03    -0.3824465E+02
     0.1446813E+03    -0.3824343E+02
     0.1446824E+03    -0.3824484E+02
     0.1446826E+03    -0.3825356E+02
     0.1446876E+03    -0.3825210E+02
     0.1446919E+03    -0.3824719E+02
     0.1447006E+03    -0.3824723E+02
     0.1447042E+03    -0.3825078E+02
     0.1446758E+03    -0.3826229E+02
     0.1446693E+03    -0.3826255E+02
END
second_area
     0.1422436E+03    -0.3839315E+02
     0.1422496E+03    -0.3839070E+02
     0.1422543E+03    -0.3839025E+02
     0.1422574E+03    -0.3839155E+02
     0.1422467E+03    -0.3840065E+02
     0.1422433E+03    -0.3840048E+02
     0.1422420E+03    -0.3839857E+02
     0.1422436E+03    -0.3839315E+02
END
END&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Using hotosm i created &lt;code class=&quot;language-text&quot;&gt;.geojson&lt;/code&gt; file and used its boundaries to create such polygon filter file. After that i only needed to extract land routes in the creared custom polygon:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sh&quot;&gt;&lt;pre class=&quot;language-sh&quot;&gt;&lt;code class=&quot;language-sh&quot;&gt;$: osmosis \
  --read-xml europe-latest.osm \
  --way-key-value keyValueList=&amp;quot;railway.tram,railway.tram_stop&amp;quot; \
  --bounding-polygon file=&amp;quot;created_polygon_filter_file_.txt&amp;quot;
  --used-node \
  --write-xml city_tram.osm&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Because in this task i had only a list of cities to create routes permutations with i also needed to determine the exact coordinates for each city. As now i had our custom Europe polygon i used &lt;a href=&quot;https://pypi.org/project/Shapely/&quot;&gt;shapely&lt;/a&gt; in order to check how properly the coordinates were detected:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; shapely&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;geometry
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; shapely&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;geometry&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;polygon

&lt;span class=&quot;token comment&quot;&gt;# Points from our custom polygon&lt;/span&gt;
coords &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;81.434750&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5.863332&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;74.786230&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;6.704456&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;62.807440&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;34.492960&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;81.434750&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5.863332&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
CUSTOM_EUROPE_POLYGON &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; shapely&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;geometry&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;polygon&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Polygon&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;coords&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;r&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; input_file&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; coordinates &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; csv&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DictReader&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input_file&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;not&lt;/span&gt; CUSTOM_EUROPE_POLYGON&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contains&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;shapely&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;geometry&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Point&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;coordinates&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;lat&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; coordinates&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;lng&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Skipped: {}, not in europe poly&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;term&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I now had an osm file which weighted in 12 Gb and that was an uncompressed osm file. The next step was the server setup.&lt;/p&gt;
&lt;h2&gt;Server setup&lt;/h2&gt;
&lt;p&gt;The result osm file weighted 12 Gb uncompressed, graphhopper will unwind it and add an additional 12 Gb for its metadata, i also needed a good amount of memory in order to comfortably work with routes. The list itself had almost 500 million routes to parse, so I could not parse it in one go, so i really needed to track what routes were processed and what not. In order to do that i decided to use redis server, its simple, reliable and very fast, also it can be used with python celery library which i decided to also use in my setup. After some considerations i decided to use &lt;a href=&quot;https://www.hetzner.com/&quot;&gt;hetzner&lt;/a&gt; EX42 type box.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4594e84787caf247434d027521392f5f/1cc3c/hetzner.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 39.87341772151899%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABqklEQVQoz1WQzW/TQBDF/WcDEiSOaIKaOwUhwYFKiAMfBy4gDiAiJTJJKgW7IkG0om1KI+HYThx/rb0/Zh1K4ElvZ3d2dua9tabvPjB5+Ybxsxd4wzHT2QzPdfE8D+/4GHcyYfKxhzs+wvnsMBgM6PV6DIdD+v0+juPUcTQaMZFa69GTx9y91+HWndvYLZtut0uj0aDZbNaxYaJts9/dp723R6vVqmlLzrabNVuy77TbHBzcxwqDgGAZkGw2ZGmGUoqyqiiKgrIs0VrXTJKEOJaaLJM7tb0DKllyBaoCSWP5vk8URRhkec6P0xMuz89ZrWMKOV9jtVqxXC5Zr9dsZLhSJZQ+STjj65dPpOE3dOFjGUUGRkWtLE9RefKnjaaSnOH/0Ft1i6eo7zeIph3Kk5uoq+dYgViez+fEMtXYDMNI9glBsCRN078NjQvjJo7j7beUCjMmk8UPFZkIVjLFMhYMDQop/Hlxxq+rS0ptVO+Umeam2UZoBteIR+SLV5y5hxSL1+j10c7ytZJKPlvJg0rv7Bpq/Y9hk5Nz5b+luHhAdHqImj9E+e/5DeuwRTKf7Vl7AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Hetzner&quot;
        title=&quot;Hetzner&quot;
        src=&quot;/static/4594e84787caf247434d027521392f5f/f058b/hetzner.png&quot;
        srcset=&quot;/static/4594e84787caf247434d027521392f5f/c26ae/hetzner.png 158w,
/static/4594e84787caf247434d027521392f5f/6bdcf/hetzner.png 315w,
/static/4594e84787caf247434d027521392f5f/f058b/hetzner.png 630w,
/static/4594e84787caf247434d027521392f5f/40601/hetzner.png 945w,
/static/4594e84787caf247434d027521392f5f/78612/hetzner.png 1260w,
/static/4594e84787caf247434d027521392f5f/1cc3c/hetzner.png 2322w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;Workers&lt;/h2&gt;
&lt;p&gt;I decided to use celery and redis as transport. The script will read each term and start to combine it in a loop with other terms until &lt;code class=&quot;language-text&quot;&gt;CONCURENCY&lt;/code&gt; number of routes is collected, then it will pass them to the celery worker group and wait for the processing to complete after that receive the results from celery and write them down. I also decided that it need a config option to start from a given point in the file, so i have introduced &lt;code class=&quot;language-text&quot;&gt;START_POINT&lt;/code&gt; config env variable.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; requests
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; csv
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; os
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; itertools
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; concurrent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;futures
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; router&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;redis_client
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; celery
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; hashlib
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; router&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tasks &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; lookup_directions
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; router&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hasher

START_POINT &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;os&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;environ&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;START_POINT&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
CONCURENCY &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;
MAX_RESULT_BATCH &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; 10_000

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;flush_batch_main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  execution_result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; celery&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;group&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lookup_directions&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      row&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; row&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; row &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; execution_result&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lookup_directions&lt;/code&gt; is our celery task and is pretty straightforward:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; __future__ &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; absolute_import&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; unicode_literals
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; celery &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; Celery

&lt;span class=&quot;token comment&quot;&gt;# Use redis as broker&lt;/span&gt;
app &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Celery&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;router&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
             broker&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;redis://&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
             backend&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;redis://&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
             include&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;router.tasks&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

GRAPH_HOPPER_URL &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;http://localhost:8989/route?point={}&amp;amp;point={}&amp;amp;type=json&amp;amp;locale=en-US&amp;amp;vehicle=car&amp;amp;weighting=fastest&amp;amp;elevation=false&amp;amp;key=&apos;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Reuse request socket and config between the requests, increases the performance&lt;/span&gt;
requests_session &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; requests&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Session&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token decorator annotation punctuation&quot;&gt;@app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;task&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lookup_directions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;start_point&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; end_point&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  path &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;{} {}&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;start_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; end_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; requests_session&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;GRAPH_HOPPER_URL&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        start_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; end_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;paths&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;and&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;paths&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      first_path &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;paths&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&apos;merged_term&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&apos;term_start&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; start_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&apos;term_end&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; end_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&apos;coordinates_start&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; start_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&apos;coordinates_end&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; end_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&apos;distance&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; first_path&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;distance&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&apos;time&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; first_path&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;time&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&apos;hops&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;first_path&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;instructions&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;except&lt;/span&gt; Exception &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; identifier&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Skipped, error: {}&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;identifier&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;merged_term&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;term_start&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; start_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;term_end&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; end_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;coordinates_start&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; start_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;coordinates_end&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; end_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;distance&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;time&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&apos;hops&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;None&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The format of graphhopper api can be looked &lt;a href=&quot;https://github.com/graphhopper/graphhopper/blob/master/docs/web/api-doc.md&quot;&gt;here&lt;/a&gt;.
The main script looked like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input_file&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; result_file&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; flush_batch&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; hasher&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; concurency&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; max_result_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  writer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; csv&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DictWriter&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result_file&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fieldnames&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;merged_term&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;term_start&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;term_end&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;coordinates_start&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;coordinates_end&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;distance&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;time&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;hops&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; quoting&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;csv&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;QUOTE_ALL&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  writer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;writeheader&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

  terms &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;csv&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reader&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input_file&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  row_batch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  result_batch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

  i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; row_1 &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; terms&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;START_POINT&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; row_2 &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; terms&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;# Track the current permutation number&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      i &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
      sorted_points &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;row_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;row_2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      sorted_points&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sort&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;lambda&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      start_point &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; sorted_points&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      end_point &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; sorted_points&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      path &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;{} {}&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;start_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; end_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; start_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; end_point&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;or&lt;/span&gt; route_exists&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Skipped, already exists: {}&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;

      row_batch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;append&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;start_point&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; end_point&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;row_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; concurency&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        row_batch&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; execution_result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; flush_batch&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;row_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        result_batch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;extend&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;execution_result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; max_result_batch&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Flushed&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        writer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;writerows&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; entry &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; result_batch&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          memorize_route&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;merged_term&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        result_batch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; row_batch&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    row_batch&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; execution_result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; flush_batch&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;row_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    result_batch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;extend&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;execution_result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; result_batch&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    writer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;writerows&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result_batch&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; entry &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; result_batch&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      memorize_route&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;merged_term&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;True&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; __name__ &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;__main__&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;os&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;environ&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;INPUT&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;r&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; input_file&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;os&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;environ&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;RESULT&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;a+&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; result_file&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      main&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input_file&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; result_file&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; flush_batch_main&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
           router&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hasher&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; CONCURENCY&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MAX_RESULT_BATCH&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memorize_route&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;route_exists&lt;/code&gt; is just a wrapper for redis client that checked redis key for existence and write one after we process it. Everything was in place and i was ready to start the processing. However, new challenges awaited me ahead. Stay tuned for the final article!&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Taming Europe routes, part 1]]></title><description><![CDATA[This will be a series of long articles, so stay tuned in for the next posts. I will be talking about hosted solutions to work with large…]]></description><link>https://programmernotes.info/taming-europe-routes-1/</link><guid isPermaLink="false">https://programmernotes.info/taming-europe-routes-1/</guid><pubDate>Sun, 03 Jan 2021 18:12:03 GMT</pubDate><content:encoded>&lt;p&gt;This will be a series of long articles, so stay tuned in for the next posts. I will be talking about hosted solutions to work with large geocode data. This all started as a simple task back in the dreaded 2020. The task was like this: hey, can we parse a list of European cities and determine which one can be a good candidate for search optimization. The file itself was a list of European cities without England, mostly west Europe, and consisted of 33000 entries. In essence, the task was to take each city and combine it with other entries from this file and check with Google keyword planner if this combination can be a good option to search optimization. Simple mathematics gives us the total number of permutations from such number of entries:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; math
math&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;perm&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;33000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# 1_088_967_000&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;That’s more than 1 billion entries to process! There is no way that Google keyword planner will process the such number of entries in time. It was obvious, that we need to shrink that value by a lot, but how we can do that?&lt;/p&gt;
&lt;h2&gt;Can i travel to it?&lt;/h2&gt;
&lt;p&gt;We had a lot of permutations. It was obvious that we don’t need all these values. So i took a sample of 5000 entries from the permutation list and run them through Google planner to determine what combination can be safely omitted. After i received the results and checked it manually, the task started to obtain its form. Turned out that most of the routes that cant be performed by land traffic usually have no search requests.&lt;/p&gt;
&lt;h2&gt;Take 1, use third party api&lt;/h2&gt;
&lt;p&gt;So, we had a list of routes and we need to determine what routes can be done by land traffic. Obviously, if you can travel from point A to B you can perform the same route but backward, so we need only half of the permutations. That’s 500 million entries to process. Still, a very large number. My first guess was to use google api to parse all these routes. That was a moment when i fully understand the enterprise costs of such services.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/252ac9757aedf36e32591037c51ba832/76435/geocode_google_pricing.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 29.11392405063291%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABH0lEQVQY02VR20rEMBTs/3+aPriC+qAg2u0993Sbtjlpx5MsiGBgOPdJMqdq2xYNo65rSClBRIgxFmSfDiAmgNLBSMWP6fyHdJzIp9LGou9HKG1grYcQClpbJtfQxmE0K0ZLUHbBJDnvU4Ga75CeIDieQ8LBpJVQGzduGMVa7F8/25e3L1ye3/Hw+Iqnywf6YYaQAeO0cD2wz71sB46HKaCyfoN1G7Rd0XQKygRYv8NwbN0OqRZ8Xyd8fvU84OB85NpWevJcfRV8+Q3+RqW/ys8kFqrrB1ybtnw5sV6JdcmyzPOCpunQdQOc8yWXZ+b14C8fkObGEpki077TnTATGNYrJ/NQIeP8ycMhbCWf68sSfgkpL4POsqxIvKxIhecHz9bMI1cd48MAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Google geocode pricing&quot;
        title=&quot;Google geocode pricing&quot;
        src=&quot;/static/252ac9757aedf36e32591037c51ba832/f058b/geocode_google_pricing.png&quot;
        srcset=&quot;/static/252ac9757aedf36e32591037c51ba832/c26ae/geocode_google_pricing.png 158w,
/static/252ac9757aedf36e32591037c51ba832/6bdcf/geocode_google_pricing.png 315w,
/static/252ac9757aedf36e32591037c51ba832/f058b/geocode_google_pricing.png 630w,
/static/252ac9757aedf36e32591037c51ba832/40601/geocode_google_pricing.png 945w,
/static/252ac9757aedf36e32591037c51ba832/78612/geocode_google_pricing.png 1260w,
/static/252ac9757aedf36e32591037c51ba832/76435/geocode_google_pricing.png 1742w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;4$ per 1000 requests! And that’s only 500_000 requests, for more numbers you need to contact sales! Same picture with other providers. To get things even worse, each provider has its rate limits, google geocode won’t allow you to perform more than 50 requests per second. 500 million requests are just too much to handle by third-party geocode services.&lt;/p&gt;
&lt;h2&gt;Take 2, maybe python?&lt;/h2&gt;
&lt;p&gt;Surely, this task was encountered before, there should be some handy python library to tackle it right? As it turns out, it is, kind of. I present you - &lt;a href=&quot;https://pypi.org/project/Shapely/&quot;&gt;Shapely&lt;/a&gt;. Shapely is a marvelous python package, that allows you to work with planar geometric objects, construct paths and determine if polygon contains some point. Here is an example of building an area from coordinates and determing if point is inside this area:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; shapely&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;geometry
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; shapely&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;geometry&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;polygon

coords &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;81.434750&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5.863332&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;74.786230&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;6.704456&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;62.807440&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;34.492960&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;81.434750&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5.863332&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
EUROPE_POLYGON &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; shapely&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;geometry&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;polygon&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Polygon&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;coords&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

p1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; shapely&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;geometry&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Point&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20.0302976&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;44.1650444&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
EUROPE_POLYGON&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contains&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The library is very simple to use, but it turned out that we can’t actually determine if we two points actually have routes between them in Europe. More than that, we also need to take into account the time needed to perform each travel, because, can travel from Copenhagen to Malagawhich but it will take more than 24 hours to finish, so we don’t actually need such route either. We definitely need some more complex solution.&lt;/p&gt;
&lt;h2&gt;Take 3, open street maps&lt;/h2&gt;
&lt;p&gt;During my work with shapely, i needed a list of coordinates that described the area of Europe. After some research, i found out that there is an open-source project that can give me that and much more - &lt;a href=&quot;https://www.openstreetmap.org/&quot;&gt;open street map&lt;/a&gt;. Open street map(OSM) project targets the creation of a free editable map of the whole world. Its just like Wikipedia, but for maps. OSM has a collection of different areas available to be downloaded as used as you like. Also, there is a technical standard for geocoded data. There is a number of applications and libraries that can use OSM datasets:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/valhalla/valhalla&quot;&gt;valhalla&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/Project-OSRM/osrm-backend&quot;&gt;osrm-backend&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/graphhopper/graphhopper&quot;&gt;graphhopper&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://docs.pgrouting.org/2.3/en/doc/src/tutorial/index.html&quot;&gt;pgrouting&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;valhalla and osrm-backend are both written in C++, need some compilation in order to work and has some complicated set up and mostly used as cli tools. Pgrouting is a psql plugin, so in order to work with large datasets, like Europe whole map will require some sirious tweaks. Graphhopper is the most intersting one from this list. It is a Java backend appliction with ready to use server and the frontend part with routing possilbities. Its ready to use google map like hosted solution.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d8dbb0b92152c82a77b2db41ee4f511a/0a47e/graphhopper_1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 68.35443037974683%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC7UlEQVQoz1XQ60/aUBgG8P6n++Ayp1tmtmSZWXbxBhRZa4GCRSjI5bTS0p7TAkUEpxLmFLZ5Q6fuEjK36VjRiWi8cFnVZJeT5+svz/scrFAo5PP5mdxseXfn6EgPyXKnCd61otu4/G+6cfmWCTq5gKJRfTSLB6azuTmsVCrpP/Uf+5Xvp3qluiOl6EEm3GVRuq1yF/43d3C50wzpCCspNOETXEGvD0SwcrlcO6qdn5+3G+0vXz/H4qRfcHSZlO6rtj+5xriP49CYmRknWG+vU8GOjVevn52dtVqNrU/fQmJYSZPDPt9tC7xj/c93DMi9biSl2SFP6BHFkyEeu2g0LtqNRrvZPD+ZXy5bmVEo4yhBPyBFY+S178KlnhdSn0eixsIqogXVMS7QaMqD6b+q+ye/Ti9O2+32ytYmkIYRJJOaa5QD94nYVaf0lBajcFzOjCmqjY+YApJ5ImnjFRdW1asH+wetVtPAb0uLE5oFQkpO2adeuhkQ7BhC92wxwEfEhIdLE7GMg1dJTsKBQkhJJ1apVOr1erN5id+tFdgJPJF2BNVnDOp/aI/eGEQ2P+BkG1BtqmqX4kQYmoBkiSdckua+xIeHhw1jtYFXix6eiBqTovaRiPuRd5yBjKg5BcRoKs3zZircGxTNIEZAlUpNBbC9vb1arXaNF98t9VjBvWG526LcNKle0V94RSdTzITkYoUBL/88CEx+rt8LnnhCT4OiDdvd3b1qvjw7O1/qHFDMXqFvlA/KfjVDJjPOyRwTTY0I0BkWrYJIRBEhQDLAmQAcwXRdNza3WoZtF5aXHtuDjkgonbdrcyNoEs/lwMbWQrE8u/7x9cbmwsZ6YWv77YftpfebxfnF+OVvH9ePW1d6Zb0QgkPSJAWzlJqlklO2N0U0ua6519jiRv7V2hxcRtnVdGA14lsJ5RYMfHJQPT6oX5wYuLS94wayoI0qGVJNU2ICT8y443k2Ps2i7BjKBOIZIZ6DsRkeTQNtFv4G8a1Lyz3iLMkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Graphhopper maps&quot;
        title=&quot;Graphhopper maps&quot;
        src=&quot;/static/d8dbb0b92152c82a77b2db41ee4f511a/0a47e/graphhopper_1.png&quot;
        srcset=&quot;/static/d8dbb0b92152c82a77b2db41ee4f511a/c26ae/graphhopper_1.png 158w,
/static/d8dbb0b92152c82a77b2db41ee4f511a/6bdcf/graphhopper_1.png 315w,
/static/d8dbb0b92152c82a77b2db41ee4f511a/0a47e/graphhopper_1.png 600w&quot;
        sizes=&quot;(max-width: 600px) 100vw, 600px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f80b46608ef0084d7f7590dcfd843792/0a47e/graphhopper_2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 89.87341772151898%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAADB0lEQVQ4y1VTyXLrNhDk//9GbrnlkPIhTlmJrM3Wc6yVAncQBIkdXCVRkuWMpKrUyxxAFIqNRvf0OAh5k8lkOBwOBoPZ2+zj8+N0Pl2v31BM14uQcak157WUJaWGF6VROi8YIUwzJ8/z1Wq12Wzcrfv2/va6fS378vsOFu1+ypt5wBfzHyWOeew1UtbWWCmMkW1dO23b9n1/uVy+73W9XvtTfzs5n6kQ8zTcSjNYZ5//LONkV1Ki85RnCWeZMcbRWjPGlFJwS9M07b3gs2+bVJTP62S0WSe5nYT1i9/MXDoKilVIU5zVVjmc8yzLintRSmEFcNd1+67LuBl64bLwMUk8P1rm5Sjv3/LLKN0/B/uXoHKklGmaHg6H75/qenesqasAipAYxxmOhWDM5vum4lxFRM6SxoGnl2X5APxccHLoWpUTWVDgzVPCmYhxkoDaqrWm1lI51lrQDGr/x3ynxUx+bhBLE05SRbNaKVCYhD4oZVJJbW7PBjDYVlUVXPFYv76+zqceF/rPRRZ4EU8ihnElZaVkJYQ1t24VGDvw6+nUc12todU7F/TDxQAG/qqxo9fxcL7+6+8x9VFnlBW8VKJrrBFcscIBwYemIYUCsO95SZIcj8fH4+2x2oXLzPNmH9vdx6cgFIc42CLNbls/CG59hhcy3TBQwgrIz3+G1ccm4XFF8GK++uXXP9bTeYJC5Hre1k88jBB2BOf7ts2Y3rpueC+EELTg3qoGRWscrdFo+vtvz/l2UysmWQ7itSrCGDuQra/LJZcVu5l4WyCb5/MZwPu2IyTiktoQeaPJ4v0HDoMCEpWmKPZICsxCQJiosGEUQdQgZDAqcRxjsLeqLJAYkXgLtECrHeah34LVLLeMAz8MRgc8wByGEWDAP8AAORheWSsoLY3RNFrt6Hskse9apTqtO2tryR2IMYwUTMR0Oh28vDw9PY3H48eQ1WUpCiJZIQPkomgRU99dShhpwa1WpVK3eBJCQPnDZIA9NiAnzzLDWc15WZBl6mOc8TjgRSYF40oD6l9x5NNJzqQvzQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Graphhopper maps&quot;
        title=&quot;Graphhopper maps&quot;
        src=&quot;/static/f80b46608ef0084d7f7590dcfd843792/0a47e/graphhopper_2.png&quot;
        srcset=&quot;/static/f80b46608ef0084d7f7590dcfd843792/c26ae/graphhopper_2.png 158w,
/static/f80b46608ef0084d7f7590dcfd843792/6bdcf/graphhopper_2.png 315w,
/static/f80b46608ef0084d7f7590dcfd843792/0a47e/graphhopper_2.png 600w&quot;
        sizes=&quot;(max-width: 600px) 100vw, 600px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4cf0626010b97ebf1d70a8daaf50e1b5/75ac7/graphhopper_3.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 67.08860759493672%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAC4jAAAuIwF4pT92AAAD00lEQVQ4yyWS/08bdRjH788A7LXFlnZs5dsyYAtziLoEI1MWE6NmLsaEDbNgjIgrtLCwmhiDxhnjDxoNceqcZOPbCl3p+LqFqJNtiVKg32h71y9312uvPdreUe55vM4fXr+83+/nnSfP50McbWpUak1GrDZU4yHLYbQ0WsBcV4tH6ixUQ2tHwdRwAo11rXDs5GloOP4iHmpqk+qbmnlLczs+e6RZqak7jvWtHWhpeR5Mdc1IvHH+QvG9D2w4YLfC0NVB6HPYFOuYHV/q6truPD8ovnv5Gr4//C28dtEBz71pxZbuvkJLx6vR7t5P8UzPKHSr+tleB7zwjh2Pnn5bIX6ZXS5SOcQky0OUZjDB7QEe7KPj6mj0xsRkYW39L1xaWwf34ircXVzDz7/+Tr7Y25dauLeGLs8yuDwruLz6AKacHuz5cBgIj+tOMZPJoC8UAZ5jMM6mlGCQwuH+j8KPvYF8XsxhJCkAzaRASlM455yWhm2DrJxL4b6YAjnLYDHH49+bIfxs7BoSztlpieZELAgclENFMaP4dxNo7e8P+3w7eTGbQZ6Nwx9eGphkAh/cvy/ZhwbZLBfDPT4ONB3DDbXM5w/g+I/fA3Hz5u9yNieiyCdB4BIYS7DApNLoGB2Jhf3eopTPYj7DQihMwW6MQ5YK7F+xWTNpNob/hpKw+iSM1G4AsCjg9O0JIMZ//k3m0jkUWBo4KojBaFLhORZt1k+Cfp93r1TMYZZnYCdEAcMwSAW3iv0D1sRDbwTDURoebUUwHo9hKZ+BuZlJJFzOGZlJMujdCUIkzqE/klD2BB5H7EO+x08eiopaWB7c2I6ClOOQ3vUXPh64TLPxCMpCAjZ3GaQpCorqueZnJ4GYuT0hy1kO+SQNwTCN2yFaKe1l0G4b8v2zuSGCJGBGyALHZ0BtxFQ8XHBcsdMlkcODggD5bBpzaRZkMY2e+RkobyhJooBCKglFUYBYklMUSVQ3tG//cP1X0ely440pN4zfWoClpRW8NeUs9FzojS7cW8LFpRVlbt4Nd+bcsKJ+rbEvv1KI6z+Nl+IR9ZW2vBjcKbMJVMiPfZcuBerbXsmf6HwLza0vo6mlE+tPdaOlrUsy17ckTnWdw/Yz57Cx/exTv6njdaw91oFEjcmUNhqNYDAYDwwGg1JTU1MymUxoNpvXdXo9q9PpgSR1+xpSq0IqWp2unH+kekhqdfL/+lMO9PrqNFGt149UVlZtVlRUBFTilZWV0aqqqj/VoZOq94VG84xHo9E4y5Ak6dFptd8crq1t02rJWVW7q+IiNZp5LUkuq/n+/wASv8dC91UaLAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Graphhopper maps&quot;
        title=&quot;Graphhopper maps&quot;
        src=&quot;/static/4cf0626010b97ebf1d70a8daaf50e1b5/f058b/graphhopper_3.png&quot;
        srcset=&quot;/static/4cf0626010b97ebf1d70a8daaf50e1b5/c26ae/graphhopper_3.png 158w,
/static/4cf0626010b97ebf1d70a8daaf50e1b5/6bdcf/graphhopper_3.png 315w,
/static/4cf0626010b97ebf1d70a8daaf50e1b5/f058b/graphhopper_3.png 630w,
/static/4cf0626010b97ebf1d70a8daaf50e1b5/40601/graphhopper_3.png 945w,
/static/4cf0626010b97ebf1d70a8daaf50e1b5/78612/graphhopper_3.png 1260w,
/static/4cf0626010b97ebf1d70a8daaf50e1b5/75ac7/graphhopper_3.png 3600w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;And the setup itself is &lt;a href=&quot;https://github.com/graphhopper/graphhopper/blob/master/docs/core/quickstart-from-source.md&quot;&gt;piece of cake&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; clone git://github.com/graphhopper/graphhopper.git
&lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; graphhopper
&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; checkout stable
./graphhopper.sh -a web -i europe_germany_berlin.pbf
&lt;span class=&quot;token comment&quot;&gt;# after Server started go to http://localhost:8989/ and you should see something similar to GraphHopper Maps: https://graphhopper.com/maps/&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The whole Europe polygon can be downloaded from &lt;a href=&quot;https://download.geofabrik.de/europe.html&quot;&gt;here&lt;/a&gt;. Graphhopper creates a fast web server that can be used to create routes(get directions) from supplied coordinates:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;curl&lt;/span&gt; http://localhost:8989/route?point&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;52.5348844&lt;/span&gt;,13.4026232&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;point&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;52.46475525477169&lt;/span&gt;,13.343352666850482&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;json&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;locale&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;en-US&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;vehicle&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;car&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;weighting&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;fastest&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;elevation&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;false&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;result:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;hints&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;visited_nodes.sum&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;198&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;visited_nodes.average&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;198.0&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;info&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;copyrights&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;GraphHopper&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;OpenStreetMap contributors&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;took&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;82&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;paths&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;distance&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;11017.167&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;weight&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;987.256351&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;987190&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;transfers&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;points_encoded&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;bbox&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;13.342298&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;52.4648&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;13.40341&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;52.534936&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;points&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ivs_IuuxpAHW@W?SxCaAPKfAdATZLl@nDvVJ`BBt@RpLdCze@n@~N?lADhAN|ARbAVx@tAvHb@fCAZ@`@z@lEVj@pBbK`@tAh@jC@n@TlAZzBz@lE^f@bBbID|@pDjQh@pDvAvGnAvFf@[XQpBA|@Ez@Q~@]p@g@fAiBp@sCRi@b@q@bEmDhCoBn@_@dAc@\\G`AA\\Bd@JhM~FrCbAdCl@pARb@BnB?bAE`AIvDm@~MgEdG`p@DdASpVxPlHSfCCtADlDJhBd@lD`BrKLt@XBd@Jf@@bAP\\NpAz@bExC|@|@fA|A\\p@j@hAvC|Hz@`BzApBlAhAxBp@p@H|FAbU]xAJdBj@n@ZtChBp@FhPVfGBvYMtDGPGbDDv@RvCD~DDlAUfFNTHpBdDjAvAjE`G^}@JKXQf@QxYqB|Fu@jf@{CJ~E&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;instructions&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;distance&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24.685&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;heading&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;121.92&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;sign&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;interval&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;text&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Continue onto Zionskirchstraße&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3554&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;street_name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Zionskirchstraße&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;distance&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;99.975&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;sign&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;interval&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;text&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Turn right onto Zionskirchstraße&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;14396&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;street_name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Zionskirchstraße&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    ....&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Not only that but also routes with different types of transport(car, train, by foot) and also estimated time to finish the route. With all these solutions in place, i was ready to parse all this dataset and complete the task. The sequence will be like this:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Download Europe polygon from download.geofabrik.de&lt;/li&gt;
&lt;li&gt;Crop it so that we don’t include Eastern Europe, England, and Scandinavia&lt;/li&gt;
&lt;li&gt;Launch Graphhopper server with the constructed polygon&lt;/li&gt;
&lt;li&gt;Write python script to query this api, parse and store into csv&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In the next article, i will describe my production setup(free Redis optimization tips included!) and scripts(some python celery magic!).&lt;/p&gt;</content:encoded></item></channel></rss>