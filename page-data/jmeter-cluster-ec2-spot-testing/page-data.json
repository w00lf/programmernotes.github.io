{"componentChunkName":"component---src-templates-blog-post-js","path":"/jmeter-cluster-ec2-spot-testing/","result":{"data":{"site":{"siteMetadata":{"title":"Programming notes"}},"markdownRemark":{"id":"be5a6991-d749-5b8f-bd71-d2542c5624a7","excerpt":"Recently i needed to perform stress test testing on one of my projects. I needed to simulate user interactions at a high scale and determine the exact breaking…","html":"<p>Recently i needed to perform stress test testing on one of my projects. I needed to simulate user interactions at a high scale and determine the exact breaking point of the application. Now, there are a lot of tools to do that, you even have cloud-based solutions that can do a lot of things for your $. Being an engineer i rejected such tools an was determined to create my own cloud testing stand, in additon i heard a lot about new aws instances type - <a href=\"https://aws.amazon.com/ec2/spot/?cards.sort-by=item.additionalFields.startDateTime&#x26;cards.sort-order=asc&#x26;trk=ps_a134p000006vwFnAAI&#x26;trkCampaign=acq_paid_search_brand&#x26;sc_channel=PS&#x26;sc_campaign=acquisition_RU&#x26;sc_publisher=Google&#x26;sc_category=Cloud%20Computing&#x26;sc_country=RU&#x26;sc_geo=EMEA&#x26;sc_outcome=acq&#x26;sc_detail=aws%20ec2%20spot%20instances&#x26;sc_content=EC2%20Spot_e&#x26;sc_matchtype=e&#x26;sc_segment=517625976421&#x26;sc_medium=ACQ-P%7CPS-GO%7CBrand%7CDesktop%7CSU%7CCloud%20Computing%7CEC2%20Spot%7CRU%7CEN%7CText&#x26;s_kwcid=AL!4422!3!517625976421!e!!g!!aws%20ec2%20spot%20instances&#x26;ef_id=Cj0KCQjwssyJBhDXARIsAK98ITS8mlje2FSiwzFXLeb9sFO-7OLtgi6GyIm0371n6GPjMeRmkfJ6DEAaAlRTEALw_wcB:G:s&#x26;s_kwcid=AL!4422!3!517625976421!e!!g!!aws%20ec2%20spot%20instances\">Amazon EC2 Spot Instances</a>. Spot instances are instances that consisted of leftovers of ec2 platform, eg amazon is running its huge servers to provide ec2 facilities and they don’t always used for 100%. That’s where you can save a lot of money if your setup does not require real-time availability. The catch here is that these leftovers can be claimed by aws at any time and your cheap t3.2xlarge instance will just go poof and be removed. Now, that can be addressed by enabling persistent support for additional $ and other settings but that’s a topic for another blog post.</p>\n<h2>Stress test conditions</h2>\n<p>I needed to perform a stress test with a sequence of requests written before by jmeter proxy requests. I needed at least 1000 active users in a span of a minute. In addition to api interaction, these scripts also required downloading large(5+Mb) static assets. After some manual testing, i determined i need at least <code class=\"language-text\">t3.2xlarge</code> server, preferably 2 of them. Jmeter is not the most efficient tool in terms of resource consumption, there are other ones like, for example <a href=\"http://tsung.erlang-projects.org/\">tsung</a> that can do it much more efficiently, but jmeter was the easiest one to use and spot instances allows you to not think a lot about consumed resources.</p>\n<h2>Cluster server creation</h2>\n<ul>\n<li>First step go to ec2 page and press <code class=\"language-text\">Launch instances</code>, then select preferably os type, i choose Ubuntu 20 for its simplicity of configuration.</li>\n<li>Choose your instance size, as described above, i needed at least 20Gb of memory so i decided to go with <code class=\"language-text\">t3.2xlarge</code>(8 cpu and 32 Gb of memory)\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3486b70c2c97059f2cd44b2d10e2712c/2c960/instance_size.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.60759493670886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABPElEQVQoz3VR2XKDMAzk/3+y02sIkITYxrfNdiVo2j6UQWOtDntXGsZpxvjxivHzDeO04PpwcD7BbAF2i/Qj7tbD+sNPOSPnQsuHlfIHDylGhLChlAxjHogxQL9959/RW1MYgkc7/Vorczt677DGKBaT2kGCpVQt9N6zMWijWBVjofjruioDuei7ppDdPM8kQeYpK+aFbD5fFHYpJX1Z4mrtOCMvOZh1bdS+VrE5p+pqLYqHXBpCIujAwzgYS/m1Q+KJzCNzgm/3FSGyse3YOMtc+QhnN14mxZ65RDy4SDkuIRTgcjWYbxYudkjchqq5LXV8Tnf1fd5xM0Hzxhe8vF8Ua108JVdKkCWkFFFkTr8l9x/J7ZQs9ft/kmXwkXPbuRRjyI4FMsPnYnQpnTnzXIos4VhKxbIsiiUn+Atg2XBZOZzpKAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ec2 instance size\"\n        title=\"ec2 instance size\"\n        src=\"/static/3486b70c2c97059f2cd44b2d10e2712c/f058b/instance_size.png\"\n        srcset=\"/static/3486b70c2c97059f2cd44b2d10e2712c/c26ae/instance_size.png 158w,\n/static/3486b70c2c97059f2cd44b2d10e2712c/6bdcf/instance_size.png 315w,\n/static/3486b70c2c97059f2cd44b2d10e2712c/f058b/instance_size.png 630w,\n/static/3486b70c2c97059f2cd44b2d10e2712c/40601/instance_size.png 945w,\n/static/3486b70c2c97059f2cd44b2d10e2712c/78612/instance_size.png 1260w,\n/static/3486b70c2c97059f2cd44b2d10e2712c/2c960/instance_size.png 2870w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></li>\n<li>Next, you need to actually tell amazon that you want to use spot instance: <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2f1d35854cc66c3e6f004f2598b780f6/9f75f/instance_details.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.67088607594937%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABOklEQVQoz5WSC26DMAyGuf8BttvsBtsB1rWIUSgBmkDzgDzIP4c+VGmq1ln6cOyIP46drGpasJ6jYj1Yd0R9KCF4h5OeVpSZIMkLaVafYmvtQzKjNYzROPY9TuMAle/gyScLYYENEbOP8LR+xrL0iTEiXhKaHfFdc5RiQtFJ5OyEHZF82UuwwaAR+oKi+LxO+U55ZEkshIBhGGC0Ap8CCiZQVS16LjFod2M0Dmr2D9F2OQsmlFJ0dbMKF5sNqo93yO0X/mur4L0Z7yHaFrwsYamvoDhe2/IEtx5KKWGdg8xz8O0WIzHv94jL72HcHxCWMzfBaw97qkakPtY1OAlpmr6nZ+Bpz1OV1oV10tcf/7zyQpWkd+Qp1tO09jNQLh02zzPlHGa3rPWRNkapkZcNXt9qvBCfRQN2qPED7E6648KSUzQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ec2 instance details\"\n        title=\"ec2 instance details\"\n        src=\"/static/2f1d35854cc66c3e6f004f2598b780f6/f058b/instance_details.png\"\n        srcset=\"/static/2f1d35854cc66c3e6f004f2598b780f6/c26ae/instance_details.png 158w,\n/static/2f1d35854cc66c3e6f004f2598b780f6/6bdcf/instance_details.png 315w,\n/static/2f1d35854cc66c3e6f004f2598b780f6/f058b/instance_details.png 630w,\n/static/2f1d35854cc66c3e6f004f2598b780f6/40601/instance_details.png 945w,\n/static/2f1d35854cc66c3e6f004f2598b780f6/78612/instance_details.png 1260w,\n/static/2f1d35854cc66c3e6f004f2598b780f6/9f75f/instance_details.png 2858w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>. We will be using 3 instances - one will work as jmeter master and results collector and the other will perform the actual testing. <code class=\"language-text\">t3.2xlarge</code> instance size for jmeter master is a little overkill, but again, i did not want to spend a lot of time on configuration. Check <code class=\"language-text\">Request spot instances</code> checkbox. After you check this option you will see the actual current prices for specified regions. Spot instances have floating pricing and can change depending on the time of the day and aws loading. In order to not blow up your budgets, you need to specify the maximum hourly price you are willing to pay for each instance. If your instance overcomes such price it will be terminated. For simplicity just set it 2 times the pricing of the current price, that will be more than safe.</li>\n<li>Add some storage for the server. Jmeter uses static heap files for its testing, 1000 concurrent users with assets download will require at least 10Gb of disk storage, so we add 40 Gb disk.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dd29570646851f5d45f9cebaeb47df60/8b95f/instance_storage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.93670886075949%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABRUlEQVQoz32SaW6DMBCFuf8pKvUq7QX6N6pKMV6wsZ3YTghLeB0bpYuaBOljzJuZ5zFQ1Uyg4Qrvny1076EIbT2M4tCmh3H7oinjy9r5A0IIRESIibjGjYqxBpy3hUjJGHPxAZFIaXs+poSUc2QUjwNxwr2ratsWXdcVtNaQUkIpBescOGPoaC2K1sF7mpKmVlTLKJfr6vqj9AghS74SnMNZi77vCUMNBlwIGCoyb2/wux2k4GBNQ40C1pIh5fKJTO8gux6Wejn5FENtLNw+YFouxFrieVowTjPOzmMKCSPpWctM81Z398jCJdSKdtqfoPYDpD9t0LM8DAUVZooj5XPuCB0nnOdsumJd/1INtOswLtsUVJTjN/OmXfXfcbn8NyuGP8OuD8Ad7caRb+3yCLqBXiMC/T5MaDy/Kjy9KOyajj6OxhfEULSuofhKhAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Disk size\"\n        title=\"Disk size\"\n        src=\"/static/dd29570646851f5d45f9cebaeb47df60/f058b/instance_storage.png\"\n        srcset=\"/static/dd29570646851f5d45f9cebaeb47df60/c26ae/instance_storage.png 158w,\n/static/dd29570646851f5d45f9cebaeb47df60/6bdcf/instance_storage.png 315w,\n/static/dd29570646851f5d45f9cebaeb47df60/f058b/instance_storage.png 630w,\n/static/dd29570646851f5d45f9cebaeb47df60/40601/instance_storage.png 945w,\n/static/dd29570646851f5d45f9cebaeb47df60/78612/instance_storage.png 1260w,\n/static/dd29570646851f5d45f9cebaeb47df60/8b95f/instance_storage.png 2848w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></li>\n<li>Skip tags step, go to 6th step: security settings. This is an important step for our setup. Because we are going to use Jmeter in cluster mode we need to open specific ports in order for the master and its cluster servers to communicate with each other and to servers to pass their test results back to the master. <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/78346c0e4db9ae020a732b41821a3a72/3c1e5/instance_security.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.0126582278481%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABGUlEQVQY01VQ2W6DQAzk/3+rjULShBw9XqNGnA0BwrIHLDC1jSo1iJF3x2N71sF6G2FFeAk5HvC62WOzP2EbnSme8RadsAnXCNcrbHcRdscPnN6/cDwzPp9wIARlWeKnKJAkCdI0QZblUKqFtYZgYQ1Fo2G0gtbdwhNnmHM9rBuWPIH5APRN04y2bdEqheahqHGKPM9JZOC9x0DwgpG00z/MoP+JC/6c1HWNOI7F7fX6TU4zQUH32+2Gx6ORoX3fwzlHsFKntSbOCce5gAvu9zsMJauqImeFiLquI6cZeCXGWGnKA9l5VdVomkb0l8tF1sU67kUNcypWWJ4+Yhw9ME9y58mjH+TsKfKeeI98nqdR9I5eKNzQS/4XriPFDH1BROYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ec2 Instance security\"\n        title=\"ec2 Instance security\"\n        src=\"/static/78346c0e4db9ae020a732b41821a3a72/f058b/instance_security.png\"\n        srcset=\"/static/78346c0e4db9ae020a732b41821a3a72/c26ae/instance_security.png 158w,\n/static/78346c0e4db9ae020a732b41821a3a72/6bdcf/instance_security.png 315w,\n/static/78346c0e4db9ae020a732b41821a3a72/f058b/instance_security.png 630w,\n/static/78346c0e4db9ae020a732b41821a3a72/40601/instance_security.png 945w,\n/static/78346c0e4db9ae020a732b41821a3a72/78612/instance_security.png 1260w,\n/static/78346c0e4db9ae020a732b41821a3a72/3c1e5/instance_security.png 2854w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>. Now i must warn you that the setting i use there is quite dangerous and you should never set up your production server as described above, but because i was going to use these servers for no more than 30m minutes and then just terminate them i decided to not bother with security group configuration and just allowed all incoming traffic to the servers, you should definitely use aws security groups for your production servers.</li>\n</ul>\n<h2>Server confuration</h2>\n<p>After that, i got 3 servers preparing to launch i wrote a simple ansible role to actually configure these servers and load all necessary files.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install openjdk\n  <span class=\"token key atrule\">apt</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> openjdk<span class=\"token punctuation\">-</span>16<span class=\"token punctuation\">-</span>jre\n    <span class=\"token key atrule\">state</span><span class=\"token punctuation\">:</span> present\n    <span class=\"token key atrule\">update_cache</span><span class=\"token punctuation\">:</span> yes\n  <span class=\"token key atrule\">become</span><span class=\"token punctuation\">:</span> yes\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install unzip\n  <span class=\"token key atrule\">apt</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span>  unzip\n    <span class=\"token key atrule\">state</span><span class=\"token punctuation\">:</span> present\n  <span class=\"token key atrule\">become</span><span class=\"token punctuation\">:</span> yes\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Download and Unarchive jmeter\n  <span class=\"token key atrule\">ansible.builtin.unarchive</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">src</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//dlcdn.apache.org//jmeter/binaries/apache<span class=\"token punctuation\">-</span>jmeter<span class=\"token punctuation\">-</span>5.4.1.zip\n    <span class=\"token key atrule\">dest</span><span class=\"token punctuation\">:</span> /home/ubuntu/\n    <span class=\"token key atrule\">remote_src</span><span class=\"token punctuation\">:</span> yes\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Copy jmeter configs and binaries\n  <span class=\"token key atrule\">copy</span><span class=\"token punctuation\">:</span> src=<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> item <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> dest=/home/ubuntu/apache<span class=\"token punctuation\">-</span>jmeter<span class=\"token punctuation\">-</span>5.4.1/bin/<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> item <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> owner=ubuntu group=ubuntu\n  <span class=\"token key atrule\">with_items</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> jmeter\n    <span class=\"token punctuation\">-</span> jmeter.properties\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create stress_test dir\n  <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">state</span><span class=\"token punctuation\">:</span> directory\n    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /home/ubuntu/stress_test\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Copy jmeter script xml\n  <span class=\"token key atrule\">copy</span><span class=\"token punctuation\">:</span> src=requests.jmx dest=/home/ubuntu/stress_test/requests.jmx owner=ubuntu group=ubuntu\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Copy seed csv\n  <span class=\"token key atrule\">copy</span><span class=\"token punctuation\">:</span> src=logins.csv dest=/home/ubuntu/stress_test/logins.csv owner=ubuntu group=ubuntu</code></pre></div>\n<p>Let’s look into each step and see what there are doing. <code class=\"language-text\">Install OpenJDK</code> uses apt to install Java 16 environment to the server. We are going to download jmeter from the official site, unzip it and overwrite some config files. <code class=\"language-text\">Install unzip</code> is required for handling zip files. <code class=\"language-text\">Download and Unarchive jmeter</code> is used to download jmeter script and unzip it into the desired location. <code class=\"language-text\">Copy jmeter configs and binaries</code> is used to tweak our JMeter settings and optimize them. Custom <code class=\"language-text\">JMeter</code> file is used because of memory settings, by default JMeter uses a very small heap size equal to just 1Gb, if you do not change this item you will get <code class=\"language-text\">Out of heap</code> error if you try to simulate a large number of requests, so we are changing this line:</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\"><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>: \"${HEAP:=\"-Xms1g -Xmx1g -XX:MaxMetaspaceSize=256m\"}\"\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>: \"${HEAP:=\"-Xms24g -Xmx24g -XX:MaxMetaspaceSize=256m\"}\"</span></code></pre></div>\n<p><code class=\"language-text\">jmeter.properties</code> tells jmeter to disable ssl support completely(again we are using this one for simplicity):</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\"><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>#server.rmi.ssl.disable=false\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>server.rmi.ssl.disable=true</span></code></pre></div>\n<p>Next, we are creating a results directory and actually copying the test <code class=\"language-text\">jmx</code> xml file and our users seed list(<code class=\"language-text\">Copy seed csv</code>) which is just a list of user credentials to use in order for login.</p>\n<p>Next let’s actually deploy our settings and assets to our servers:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$: ansible-playbook -i hosts jmeter_node.yml</code></pre></div>\n<h2>Cluster testing</h2>\n<p>Our servers are all set up and ready for action. Here is lying the final catch. If you try to launch <code class=\"language-text\">jmeter-server</code> on ec2 node you will receive a warning in the log file that it started to use internal ec2 node ip that is configured as the hostname for our servers and as such there will be problems with external requests and configuring servers to run the test. You actually need to use here your public ips:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$: ./jmeter-server -Djava.rmi.server.hostname=%{YOUR_PUBLIC_IP}</code></pre></div>\n<p>Again, if you have configured security groups for your servers you dont need such settings at all.</p>\n<p>And the final step: launch testing on the cluster and write results into <code class=\"language-text\">/home/ubuntu/stress_test/results</code> folder and track the progress in <code class=\"language-text\">/home/ubuntu/stress_test/results/main.csv</code> file:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">mkdir -p /home/ubuntu/stress_test/results &amp;&amp; \\\n\t \t ./jmeter -Djava.rmi.server.hostname=%{YOUR_PUBLIC_IP} \\\n\t\t-R ec2-1-*.compute-1.amazonaws.com,ec2-2-*.compute-1.amazonaws.com -n \\\n\t\t-t /home/ubuntu/stress_test/requests.jmx -l /home/ubuntu/stress_test/results/main.csv \\\n\t\t-e -o /home/ubuntu/stress_test/results</code></pre></div>\n<p>After the test is started you can track you progress through <code class=\"language-text\">main.csv</code> results file. In essence, it’s just a csv file that gets its line appended by cluster servers periodically.</p>\n<p>Pandas is a perfect instrument to interpret your test results:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> pandas\n<span class=\"token keyword\">import</span> matplotlib<span class=\"token punctuation\">.</span>pyplot <span class=\"token keyword\">as</span> plt\n\nstress <span class=\"token operator\">=</span> pandas<span class=\"token punctuation\">.</span>read_csv<span class=\"token punctuation\">(</span><span class=\"token string\">'main.csv'</span><span class=\"token punctuation\">)</span>\nstress<span class=\"token punctuation\">[</span><span class=\"token string\">'timestamp'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> pandas<span class=\"token punctuation\">.</span>to_datetime<span class=\"token punctuation\">(</span>stress<span class=\"token punctuation\">[</span><span class=\"token string\">'timeStamp'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>unit<span class=\"token operator\">=</span><span class=\"token string\">'ms'</span><span class=\"token punctuation\">)</span>\ntime_series <span class=\"token operator\">=</span> stress<span class=\"token punctuation\">.</span>loc<span class=\"token punctuation\">[</span>stress<span class=\"token punctuation\">[</span><span class=\"token string\">'label'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>isin<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'Login request'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'timestamp'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'responseCode'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\ntime_series\\\n  <span class=\"token punctuation\">.</span>groupby<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>pandas<span class=\"token punctuation\">.</span>Grouper<span class=\"token punctuation\">(</span>key<span class=\"token operator\">=</span><span class=\"token string\">\"timestamp\"</span><span class=\"token punctuation\">,</span> freq<span class=\"token operator\">=</span><span class=\"token string\">\"15s\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'responseCode'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\\\n  <span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\\\n  <span class=\"token punctuation\">.</span>reset_index<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\\\n  <span class=\"token punctuation\">.</span>pivot<span class=\"token punctuation\">(</span>index<span class=\"token operator\">=</span><span class=\"token string\">'timestamp'</span><span class=\"token punctuation\">,</span> columns<span class=\"token operator\">=</span><span class=\"token string\">'responseCode'</span><span class=\"token punctuation\">)</span>\\\n  <span class=\"token punctuation\">.</span>plot<span class=\"token punctuation\">(</span>kind<span class=\"token operator\">=</span><span class=\"token string\">\"bar\"</span><span class=\"token punctuation\">,</span> figsize<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> stacked<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Here i took the result csv downloaded from the server, converted its unix timestamp column into datetime then created data frame with timestamp/response code count grouped by each 15 seconds and then displayed a plot using <code class=\"language-text\">matplotlib.pyplot</code>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/868a208583d8b890c2d7f0ee7fbbaee0/9d6a9/pandas_plot.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.53164556962025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABzElEQVQoz22S208TQRTG+Y9NxAsG8F0SX3jzwTuoXVnwSfSFINpCCEYopm3CTS5pl9rZ2fvuzJZ+npnZbUvjJpPffOc7883ZzU7JNEev14PjdHDtOJpqdbvX8BlHyhh810XgciRhgIR6Y9Kcu3DJY6Q5aUZ7z/UwhVwiiSP8ZdTk+eB+AEaH41RA9vtIZA6R95ESM1qp7CMjrfZSkzwhEQYBpMgoUD832Gg6WN45x9OvLdg/r7Cw3oS9d4EnnxtYKWjvXQ71wnpD+6qvsnuOxS+/cdnlJlBKgdfVUzzbPMbsah2vqmeYsQ+oZvimRlwptGJt5D+y65p3K/vYbDkmsO2GZBzg7fYfzK8das4Rl26xPsHDW/0P6aJvZWCHAmf1JKZRTaQOqkY18f+o/aJf8cHHscA2CzC3aiZ8/MlMNL824vKEHmfZrz7F1vgrT1v7eP7jVN/0gnhf8wz3iC8VrUJbRpd+yTvvf2Gj0TGBPEzwoXaErWYb1vaxZoX4fYLDemukrZ0TzXfVIzSumAkcDG4Q+hwiSxD5HkSaGE2MAg8ZMQ5MvfTLejSsc/qlBQUOgDzPEUUx0ixDFMfICo5rRj9+HCd6pRN+SSEE/gF64P2I3ZTrJwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Pandas plot\"\n        title=\"Pandas plot\"\n        src=\"/static/868a208583d8b890c2d7f0ee7fbbaee0/f058b/pandas_plot.png\"\n        srcset=\"/static/868a208583d8b890c2d7f0ee7fbbaee0/c26ae/pandas_plot.png 158w,\n/static/868a208583d8b890c2d7f0ee7fbbaee0/6bdcf/pandas_plot.png 315w,\n/static/868a208583d8b890c2d7f0ee7fbbaee0/f058b/pandas_plot.png 630w,\n/static/868a208583d8b890c2d7f0ee7fbbaee0/40601/pandas_plot.png 945w,\n/static/868a208583d8b890c2d7f0ee7fbbaee0/78612/pandas_plot.png 1260w,\n/static/868a208583d8b890c2d7f0ee7fbbaee0/9d6a9/pandas_plot.png 2256w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Easy as it can be</p>\n<h2>Conclusion</h2>\n<p>Aws spot instances is a great tool if you don’t need constant availability. It’s perfect for stress testing, CI builds and even beats lambda if you need to process a large number of tasks asynchronously.</p>","frontmatter":{"title":"Stress testing with jmeter cluster on ec2 spot instances","date":"September 04, 2021","description":"This is a step-by-step guide of how to perform a huge stress test with jmeter cluster using cheap ec2 aws spot instances"}},"previous":{"fields":{"slug":"/taming-europe-routes-3/"},"frontmatter":{"title":"Taming Europe routes, part 3"}},"next":null},"pageContext":{"id":"be5a6991-d749-5b8f-bd71-d2542c5624a7","previousPostId":"3e2553c4-1433-52dd-882e-f7d24dc12fc8","nextPostId":null}},"staticQueryHashes":["2511339400","2841359383"]}